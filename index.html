
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Redth</title>
  <meta name="author" content="Jon">

  
  <meta name="description" content="Just before the new year, I wrote a post about switching back to Android (to a Nexus 4), and I was excited at the prospect. I explained that I’d been &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://Redth.github.io/Blog">
  <link href="/Blog/favicon.png" rel="icon">
  <link href="/Blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/Blog/atom.xml" rel="alternate" title="Redth" type="application/atom+xml">
  <script src="/Blog/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/Blog/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/Blog/">Redth</a></h1>
  
    <h2>code, ramblings, and other fun activities</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/Blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:Redth.github.io/Blog" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/Blog/">Blog</a></li>
  <li><a href="/Blog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/Blog/month-with-android">A Month With Android</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-28T00:00:00-05:00" pubdate data-updated="true">Feb 28<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Just before the new year, <a href="/Blog/why-i-am-looking-forward-to-android">I wrote a post about switching back to Android</a> (to a Nexus 4), and I was excited at the prospect.  I explained that I’d been a long time iOS user (quite happily so), except for a brief stint on Android 2.3 (Gingerbread) which ended not so well.</p>

<p>Well, it’s been about a month now since I’ve switched back to Android, and I’m not looking back anytime soon!  I’m going to do a quick recap about the things I love, and the things I miss:</p>

<h2>What I Love</h2>

<ul>
<li><strong>Pre-Load All the Things!</strong> This is something I’m surprised people don’t complain more about, and one thing that has bothered me about iOS since day one.  It’s gotten better with faster devices and faster network connections, but I <em>REALLY</em> hate getting for instance, a Twitter notification, and then once I launch the app, having to wait for the item that triggered the notification to be loaded.  I really love it when Android apps go out and prefetch this data when a Push Notification comes in, so that when I decided to act on the notification and open the app, the data is already there.  The same goes for email.  If you don’t want to use the default mail app, every time you open the mail app (Gmail for instance), you must wait for the data to load, even though you probably already know who the email is from since it told you in the push notification.  I cannot stress enough <em>HOW MUCH TIME</em> this has given back to me on Android.</li>
<li><strong>Real Estate Maven</strong> I always thought the bigger phones were too big.  I drank the iPhone screen size Kool-Aid, but I loved the bigger iPhone 5.  I will say that 6” seems too big still, but my 4.7” Nexus 4 screen is just awesome.  It still fits easily in my pocket, and the added real estate is great for typing, and browsing.  Even the iPhone 5 feels too tiny now when I have it in my hands.</li>
<li><strong>The Google Experience</strong> I’m a big user of Google services, so it comes as no surprise that I love the Google apps on Android.  Google has recently improved its iOS offering dramatically, but at the end of the day it still works just a bit better on Android.</li>
<li><strong>Settings Quick Toggles</strong> In the pull down notification bar, there’s a button that flips to a view of tiles of several shortcuts to settings, such as Brightness, WiFi, Airplane mode, Bluetooth.  In 4.2.2, you can now quickly toggle some of these things on and off from this menu.  So, to toggle WiFi, I swipe down, tap the settings button, and tap and hold the WiFi.  Pretty quick and less annoying than iOS</li>
</ul>


<blockquote><p><img src="/Blog/images/Android-Love/Quick-Toggles.png" alt="Quick Toggle Settings" /></p></blockquote>

<ul>
<li><strong>Apps without Borders</strong> One thing that always bugged me about iOS as an end user was how each app felt like the lonely island it was.  I love in Android how when I tap a link, or perform some action, I’ll get a little menu asking me which App I’d like to have handle this action.  iOS does this to an extent now, but Android is better at it, and Android effectively lets me choose a default App to deal with the content type.  I love not being forced into using the default Mail app or Browser, if I don’t want to!</li>
</ul>


<blockquote><p><img src="/Blog/images/Android-Love/Share-Content.png" alt="Sharing Content" /></p></blockquote>

<ul>
<li><strong>Google Now</strong> Siri is great, but Google Now is better in almost all respects.  I find the voice transcription way faster and more accurate, and Google Now’s ‘card’ design really works for me.  If you can get over the fact Google is in your email, you can learn to love having a card pop up with tracking info on the package you just ordered, or movie tickets you bought.  There’s so much depth to Google Now it could be its own post, but it’s safe to say I really like it.</li>
</ul>


<blockquote><p><img src="/Blog/images/Android-Love/Google-Now-Cards.png" alt="Google Now Cards" /></p></blockquote>

<ul>
<li><strong>Notifications</strong> I’ve always liked Google’s notification bar way better than how iOS deals with it, so I’m not surprised to feel right at home with it.  I am pleasantly surprised, however, at how useful having an LED indicator for notifications is.  The LED basically allows me to decide if I need to even turn my screen on or not.  I also really like how apps are starting to take advantage of rich notifications in the pull down tray.  Music apps allow me to skip next, twitter notifications allow me to tap reply right from in the tray.  This is a really strong point for Android, and I find myself wasting much less time on Notifications than I did in iOS</li>
</ul>


<blockquote><p><img src="/Blog/images/Android-Love/Rich-Notification.png" alt="Rich Notifications" /></p></blockquote>

<ul>
<li><strong>UI</strong> This is where many of you will disagree with me.  I actually have taken a strong liking to the Android UI, or at least the apps that do a good job of it.  If you haven’t played with Android recently, you may not realize that developers have started to take care with how they design their apps.  There’s still a lot of junk out there, but for nearly any App I use on a regular basis, there’s a very nicely designed app Available now.</li>
<li><strong>Lock Screen</strong> There’s three things I love about the lock screen on Android.  Using a pattern to unlock my screen as opposed to a numeric code, Having widgets on my lock screen, and specifically, DashClock which adds many notification icon types to the lock screen (much like windows phone 8) – It’s a beautifully designed app and something I’d love to see integrated right into Android</li>
</ul>


<blockquote><p><img src="/Blog/images/Android-Love/Lock-Screen.png" alt="Lock Screen" /></p></blockquote>

<ul>
<li><strong>FREEEDOM!!!</strong> Seriously though, it’s really liberating not being told you can’t do something on your device.  If I want to use a different keyboard, I can.  If I want to use a different default Mail app, I can.  I am sick of Apple telling me to do things a certain way.  I realize for most users, that is fine, but I’m a power user darnit, let me tweak!</li>
</ul>


<h2>What I Miss</h2>

<p>There’s a few things I do, genuinely miss from iOS.  Luckily, none of them are really dealbreakers for me:</p>

<ul>
<li><strong>iMessage</strong> Many of my friends and family (including my wife) have iPhones.  I have unlimited texting, so it’s not that big of a deal not to have iMessage, but I found it oddly more reliable than sending text messages (especially between carriers) in some cases.  I’ve mostly switched to Facebook Messenger if I’m chatting with a friend who’s on facebook (which most are).</li>
<li><strong>Fit &amp; Finish</strong> I really only added this in because I felt a bit of a traitor since my list of things I miss is so short.  There is some truth here though, there’s plenty of apps that look nasty.  Luckily, most of those apps are apps I do not use.  At this point the market is mature enough that you can pretty much find an app that looks good to do whatever you need.  I expect this to only get better!</li>
</ul>


<h2>These are a few of my favourite apps</h2>

<p>After all this talk, I thought it would be a good idea to show what Apps I use regularly.  Here’s my top 10:</p>

<ol>
<li><a href="https://play.google.com/store/apps/details?id=net.nurik.roman.dashclock">DashClock</a> – I already mentioned it, and it’s not really an App, but a lock screen widget.  If you have Android 4.2+, you MUST get this app, and some of the addons for it</li>
<li><a href="https://play.google.com/store/apps/details?id=com.dotsandlines.carbon">Carbon for Twitter</a> – It’s relatively new, but this is the Twitter app Android has been waiting for</li>
<li><a href="https://play.google.com/store/apps/details?id=com.facebook.katana">Facebook</a> – OK, my friends are all doing it, so I need it to.  The App is quite well done (native) on Android nowadays</li>
<li><a href="https://play.google.com/store/apps/details?id=com.devhd.feedly">Feedly</a> – I use Google Reader, and it was a struggle to find a decent app for it.  Feedly fills this gap for me</li>
<li><a href="https://play.google.com/store/apps/details?id=com.podkicker">Podkicker</a> – Podcasts occupy my long commutes, so a decent podcast app is a requirement.  Doggcatcher is good too, but a bit overly complicated.  Podkicker is lean, fast, simple, and looks nice</li>
<li>Chrome, Gmail, Google Talk – I’ll lump these all together since they come by default, but they really are very well done.  I love using Chrome on my mobile!</li>
<li><a href="https://play.google.com/store/apps/details?id=com.dropbox.android">Dropbox</a> – I tend to use this one daily.  It’s very solid and well constructed for android.</li>
<li>Google Maps – It’s still better on Android than iOS!  I love the offline caching feature too, so useful as I live near Detroit and go over there a lot, but don’t want to incur the roaming data fees</li>
<li><a href="https://play.google.com/store/apps/details?id=com.onelouder.baconreader.premium">BaconReader</a> – This is my reddit client of choice</li>
<li><a href="https://play.google.com/store/apps/details?id=com.handmark.expressweather">1Weather</a> – a beautiful weather app.  Here’s a great example of the potential for nice looking apps on Android</li>
</ol>


<p>So, to sum it all up, I’m very happy with my Nexus 4.  Both from a hardware perspective, but I’m also really enjoying Android 4.2, it feels much more polished, useful, functional, efficient, etc.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/Blog/get-your-monotouch-apps-ready-for-iphone-5-today">Get Your MonoTouch Apps Ready for iPhone 5 / iOS 6 Today!</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-09-13T00:00:00-04:00" pubdate data-updated="true">Sep 13<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>So the new iPhone 5 has arrived, as well as the Gold Master iOS6 SDK!  Hurray!</p>

<p>Unless you&#8217;ve been under a rock, you know that the iPhone 5 has a taller screen, which means a new screen resolution to deal with for us developers!  Apple is lacking  bit in their own documentation, but a few developers have figured out how to best handle the new resolution.</p>

<p>First of all, the new resolution is <em>640x1136</em>, that&#8217;s 640 pixels wide, by 1136 high.  Now, just like the Retina display, even though this is the resolution, many parts of the iOS API report back the sizes in points rather than pixels, which means the new size in points is really <em>320x568</em>.  I&#8217;d like to share with you how you can get your MonoTouch apps up and running to be compatible with the new resolution today!</p>

<h3>First, Install the X-Code 4.5 GM iOS6 SDK from the Apple Developer site</h3>

<p>It&#8217;s listed as the iOS6 beta at the time of writing this post, but it&#8217;s really GM once you get to the download section.  You must be part of the paid Apple Developer program to be able to access this.  Download the .dmg, mount it, and drag XCode into your Applications folder.  You may want to rename the old one so you can revert to it if need be.  I renamed the old one <em>XCode 4.4.1.app</em>.</p>

<h3>Create a Default.png of the correct size</h3>

<p>The way that iOS6 determines if your app is Tall compatible or not is by looking for a specifically sized and named image file for your splash/default screen.  The name of this file is:</p>

<blockquote><p>Default-568h@2x.png</p></blockquote>

<p>This file must actually be <em>640x1136</em> pixels in size.
Add this file to your MonoTouch Application Project, and make sure the Build mode is set to Content.</p>

<blockquote><p><img src="/Blog/images/MonoTouch-iPhone5/Default-568h.png" alt="" /></p></blockquote>

<h3>Change the Simulator to iPhone (Retina 4-inch)</h3>

<p>After your MonoTouch Application starts in debug mode, you may need to change the Simulator to use the new hardware type.  Go to the Hardware -> Device menu, and select “<em>iPhone (Retina 4-inch)</em>”.  You may need to re-launch your app after doing this.</p>

<blockquote><p><img src="/Blog/images/MonoTouch-iPhone5/iPhone5-Simulator.png" alt="" /></p></blockquote>

<p>Presto, your app now runs in ‘Tall&#8217; mode!</p>

<h3>Create new sizes of other Image assets</h3>

<p>Unfortunately, the image naming convention of -568h@2x.png only seems to extend to the Default image, but not other images in your application.  This means if you&#8217;re using a custom background image for your view (eg: UITableView background), you will likely need to create a new background image of the correct resolution, and determine in your application when to use each image.</p>

<p>For example, in my non-4inch compatible app, I have two images:</p>

<ol>
<li>Images/TableViewBackground.png – <em>320x358</em></li>
<li>Images/TableViewBackground@2x.png – <em>640x716</em></li>
</ol>


<p>With the new resolution, I&#8217;ll need to create a third image (I&#8217;ve decided to use the -568h@2x.png naming convention even though it isn&#8217;t observed by Apple):</p>

<ol>
<li>Images/TableViewBackground-568h@2x.png</li>
</ol>


<h3>Write some code to detect iPhone 5 and use the new Image Assets</h3>

<p>Now as I mentioned, even though I&#8217;ve named the image just like the way Apple detects the new default image, iOS6 (at least currently) doesn&#8217;t know to use it automatically, so we have to write some code to detect when the app is running on an iPhone 5, and then to use the correct image when that&#8217;s the case.</p>

<p>Here&#8217;s some sample code to detect whether or not we have an iPhone 5.  I&#8217;ve elected to call it ‘Tall&#8217; detection, as the iPhone 6 will likely use this tall resolution too. <strong>NOTE:</strong> Thanks to <a href="http://twitter.com/jtclancey" title="@jtclancey">@Clancey</a> for some additions to the IsTall detection!</p>

<p>~~~~{.csharp}
public static bool IsTall
{
  get
  {</p>

<pre><code>return UIDevice.CurrentDevice.UserInterfaceIdiom 
         == UIUserInterfaceIdiom.Phone 
       &amp;&amp; UIScreen.MainScreen.Bounds.Height 
         * UIScreen.MainScreen.Scale &gt;= 1136;
</code></pre>

<p>  }   <br/>
}
~~~~</p>

<p>Finally, the approach I take in my applications is to use a common property for the image, and make that property getter decide on the height of the device, and which image to return:</p>

<p>~~~~{.csharp}
static UIImage tableViewBackgroundImage = null;
public static UIImage TableViewBackgroundImage
{</p>

<pre><code>get
{
    if (tableViewBackgroundImage == null)
        tableViewBackgroundImage = IsTall 
            ? UIImage.FromFile("Images/TableViewBackground-568h@2x.png")
            : UIImage.FromFile("Images/TableViewBackground.png");

    return tableViewBackgroundImage;
}
</code></pre>

<p>}
~~~~</p>

<p>In this example, I keep a single static instance of my background image around, and lazy load it based on whether or not it&#8217;s a tall device.  This way the same image instance is shared for multiple viewcontrollers that use it!  In the case where it&#8217;s not a tall device, Apple still obeys the @2x.png naming convention to load retina graphics automatically, so you still don&#8217;t have to do that detection, it&#8217;s done for you.</p>

<h3>Other considerations</h3>

<p>If you have any other code that does anything with height calculations, or maybe creating a view to be a certain height, you may also need to update this code.  The general rule is you should now be calculating heights and y-coordinates based on the UIScreen.MainScreen.ApplicationFrame or UIScreen.MainScreen.Bounds.  This is probably a good practice anyway, and hopefully you don&#8217;t need to do too much work since you&#8217;ve already been following that good practice, right?</p>

<p>Hopefully that helps get your MonoTouch apps prepared for iPhone 5, before it&#8217;s even out!</p>

<h2>UPDATE:</h2>

<h3>Select the right Image!</h3>

<p><a href="http://twitter.com/martinbowling" title="@martinbowling">@martinbowling</a> contributed another nice method to add to your &#8216;helper&#8217; class shortly after this post was originally published.  It will help you select the right Image in code, easily!  It expects that you name your &#8216;Tall&#8217; image files with the <em>-568h@2x</em> convention.  This is another, even better technique than I&#8217;ve illustrated above.  Perhaps Xamarin will adopt this method in the future&#8230;</p>

<p>~~~~{.csharp}
private static string tallMagic = &#8220;-568h@2x&#8221;;
public static UIImage FromBundle16x9(string path)
{</p>

<pre><code>//adopt the -568h@2x naming convention
if(IsTall())
{
    var imagePath = Path.GetDirectoryName(path.ToString());
    var imageFile = Path.GetFileNameWithoutExtension(path.ToString());
    var imageExt = Path.GetExtension(path.ToString());

    imageFile = imageFile + tallMagic + imageExt;

    return UIImage.FromFile(Path.Combine(imagePath,imageFile));
}
else 
{
    return UIImage.FromBundle(path.ToString());
}
</code></pre>

<p>}
~~~~</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/Blog/the-problem-with-apples-push-notification-ser">The Problem With Apples Push Notification Service&#8230; Solutions and Workarounds&#8230;</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-09-06T00:00:00-04:00" pubdate data-updated="true">Sep 6<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Push Notifications have intrigued me since Apple first introduced them in iOS years ago.  RIM had been doing this for a while, but as a platform it never excited me.  As soon as the documentation for their APNs protocol was released I started busily implementing a solution to send push notifications in C#.  The first version of the protocol was already terrible, but I’m not going to harp on that as we’ve got a newer version that’s only slightly better to tear apart.</p>

<p>I’m the author of PushSharp (https://github.com/Redth/PushSharp) which is a .NET library to assist developers in delivering push notifications on as many platforms as possible (iOS, Android, Windows, Windows Phone, and HTML5).  This library was the culmination of my previous efforts in individual libraries (APNS-Sharp and C2DM-Sharp mostly), and represents a more abstracted, standardized, easier way to support push notifications on all the platforms you may target as a developer.</p>

<p>This post is a chance for me to vent, to explore my frustrations with Apple’s APNS protocol, and hope that they somehow listen and change it.  You’ll notice how there’s no complaining about the way the other platforms implement their protocols.  This is because they aren’t terrible (though they aren’t perfect either).</p>

<h3>Apple’s Enhanced Format for Push Notifications</h3>

<p>I had great hopes that Apple finally fixed its protocol when they introduced the Enhanced format (basically v2 of their protocol).  Both the original and the enhanced format are binary protocols.  You can quickly see the differences between the two in the diagrams below:</p>

<blockquote><p>Original Protocol:
<img src="/Blog/images/Problem-With-APNS/Original-Binary-Protocol.png" alt="" /></p>

<p>Enhanced Protocol:
<img src="/Blog/images/Problem-With-APNS/Enhanced-Binary-Protocol.png" alt="" /></p></blockquote>

<p>You’ll notice that in the enhanced protocol, there’s two additional bits of information (besides the first byte being 1, indicating that it’s the new protocol as opposed to 0 in the original).  These are two very good additions to the protocol:</p>

<ol>
<li><p>Identifier – Your own 4 byte data to uniquely identify the notification – this is important as it’s returned to you in the error response packet if there’s a problem.</p></li>
<li><p>Expiry – A point in time after which the message is no longer valid if it has not already been delivered and can be discarded from Apple’s servers</p></li>
</ol>


<p>In the original protocol, whenever you send Apple a notification that has a problem with it (maybe it’s too big, or it has an invalid device token or malformed payload, etc.), it simply closes the TCP connection without any warning.  You are left to assume something is corrupt in your notification.</p>

<p>With the enhanced protocol also handles bad notifications it receives a bit differently. It still closes the connection to you when there’s an error, but before it does so, it sends back an error response packet.  You can see the format in the diagram below, along with a list of status codes and their meanings:</p>

<blockquote><p>Error Response Packet:
<img src="/Blog/images/Problem-With-APNS/Error-Response-Packet.png" alt="" /></p></blockquote>

<p><del>
Status Codes &amp; Meanings
0  - No errors encountered
1   - Processing error
2   - Missing device token
3   - Missing topic
4   - Missing payload
5   - Invalid token size
6   - Invalid topic size
7   - Invalid payload size
8   - Invalid token
255 - None (unknown)
</del></p>

<p>This packet is quite simple, with the first byte presumably indicating the protocol version, the second byte being the status or error code (Apple provides us with a list of status codes and what they mean – interestingly enough one of the status codes is ‘0 – No errors encountered’ – just keep this in mind for later).  The final piece of info is the Identifier.  This identifier will correspond to the identifier of the notification you sent which caused the error condition.</p>

<h3>What’s the problem here?</h3>

<p>So far so good, right? Well, not so much.  In theory this all sounds very good.  Finally, we get an error response from the service, and some additional functionality.  But there are still two major issues with the protocol that you would discover very quickly if you decided to try and implement a client for it yourself:</p>

<ol>
<li><p>Apple never sends a response for messages that succeeded.</p></li>
<li><p>An error response may not immediately be returned before you have a chance to send more notifications to the stream, but before Apple closes the connection.  These notifications that might still ‘make it through’ are left in limbo.  They are never acknowledged or delivered, and never have error responses returned for them.</p></li>
</ol>


<h3>How could Apple fix this?</h3>

<p>Remember how I told you to keep in mind the error response status code of ‘0 – No errors encountered’?  This is the silver bullet.  If Apple simply always returned an error response, for every notification, even if the notification succeeded, we could simply build a library that wrote a notification to the stream, waited for a response, and then moved onto the next notification, over and over.  There’d be no business of waiting around for an error response that might never come, and greatly simplify the pains of implementing this protocol.  Apple might argue that this would consume more bandwidth, and while they may be right, in this day and age it would only amount to another ~6 MB per 1,000,000 notifications delivered.  Considering that Google and Windows Phone both use HTTP protocols and generate significantly more bandwidth based on the underlying protocol alone, and are able to keep their infrastructure running, an extra 6 bytes per notification should be pocket change to Apple in the cost of maybe a few additional servers and bandwidth allocation.</p>

<p>It’s such a simple answer.  It’s even in Apple’s own documentation.  Yet, it’s not our reality.</p>

<h3>So what is the workaround?</h3>

<p>I’ve looked at many libraries, written in many different languages, to see how they worked around this problem.  In about 99% of the cases I’ve observed, they all use the same, sadly inefficient approach: Waiting.</p>

<p>So again, we have a connection to Apple’s APNS server, and we want to send notifications over that connection repeatedly, and as fast as possible.  Apple never sends us a response if a notification was sent successfully, but if one failed, they will send us an error response and close our connection.</p>

<p>The problem is, if we keep sending notifications over and over again, we might send a second, or third notification before Apple ever sends us an error response for the first one that failed.  If this happens, the second and third notifications are never delivered, and are lost forever.</p>

<p>The easiest way to solve this is to asynchronously read from the connection stream, waiting for an error response.  In doing so, however, this means you must also wait a little while after you write each notification to the stream to see if your asynchronous read ever receives anything.  You can’t just do a synchronous blocking read on the stream since you’d be waiting indefinitely if the notification succeeded (since Apple sends no response in this case).  To make matters worse, Apple doesn’t guarantee how quickly an error response will be sent to us. I’ve seen libraries wait for an error response from anywhere between 100 to 500 milliseconds.</p>

<p>It should be painfully obvious to you by now why this approach is flawed.  If you have to wait even 100 milliseconds after sending every notification, that would take you almost 28 hours to send 1,000,000 notifications over a single connection!</p>

<p>Most libraries employ the use of multiple connections to circumvent this new issue they’ve created for themselves by waiting between each notification.  If you use 10 connections to apple’s servers, that cuts your time down to 2.8 hours.  This is better, but why should it take 10 connections 2.8 hours to deliver a theoretical maximum of only 300MB of data (1,000,000 notifications * 301 bytes maximum size per notification)?  This is asinine!</p>

<h3>A better workaround</h3>

<p>I just couldn’t stand the thought of wasting 100-500 milliseconds per notification sent.  I figured there had to be a better way, and I think I’ve found it!  PushSharp employs a technique that is fairly easy in theory, and was a bit more difficult to implement in code.</p>

<p>Each time a notification is written to the connection stream, it is then added to a ‘Sent’ queue.  If an error response is received, the corresponding notification is located in the ‘Sent’ queue (by its identifier).  Anything before the error-causing notification in the queue is removed and assumed to be successfully sent.  Anything after the error-causing notification is assumed to be lost, and re-queued to the ‘To Send’ queue to be tried again.  There is also a cleanup thread running that constantly checks the oldest notification in the ‘Sent’ queue to see if it’s older than a few seconds and if so, it is assumed to have been successfully sent and is removed from the ‘Sent’ queue.  This effectively moves the waiting period for an error response outside of the scope of the connection to the APNS servers.  The diagram below illustrates how the Sent queue works:</p>

<blockquote><p>PushSharp Sent Queue
<img src="/Blog/images/Problem-With-APNS/PushSharp-Sent-Queue.png" alt="" /></p></blockquote>

<h3>Conclusion</h3>

<p>So that’s it, that’s my big speech on why Apple’s Push Notifications are so troublesome, how they could make my life a lot easier with a couple small changes, and how I’ve learned to cope with the situation for now.  I hope you enjoyed my ramble, and do please check out PushSharp!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/Blog/2010/10/12/monodroid-custom-listadapter-for-your-listview">MonoDroid - Custom ListAdapter for Your ListView</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-05-13T00:00:00-04:00" pubdate data-updated="true">May 13<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I don’t know about you, but the main thing I’m interested in on any new mobile development platform for some reason, is LISTS. I think I’m so fixated on lists is because of the way the iPhone so successfully introduced the paradigm of list based navigation. Everything can be done in a series of lists (ok not really, but they are crucial to many apps!).</p>

<blockquote><p><img src="/Blog/images/MonoDroid-Custom-ListAdapter/CustomList.png" alt="" /></p></blockquote>

<p>Naturally then, the first thing I sought out to do on MonoDroid was to create a list. Easy, piece of cake… If you want to create a boring old list with a single line of text for each item. This is no doubt, an important part of every developer’s Hello World development phase, but it doesn’t take long before you’re craving images, several text elements, and possibly even some checkboxes and/or buttons (easy there tiger). For every ListView in Android, there is a prince charming Listview Adapter to save the day.</p>

<p>The most basic of examples which you’ve no doubt seen involve an ArrayAdapter of some sort, with the default <em>Android.R.Layout.SimpleListItem</em> or whatever it is called. BOOORING. What we need to do to make something exciting is create our own custom ListView Adapter. Now, you could use a SimpleAdapter to map fields to certain resource id’s of a layout, but if you look at a java example of this, ‘Simple’ quickly becomes a relative term. What I like to do is create my own adapter deriving from the BaseAdapter class (how fitting).</p>

<p>Here’s some code for my custom list adapter (explanation to follow):</p>

<p>~~~~{.csharp}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;</p>

<p>using Android.App;
using Android.Content;
using Android.OS;
using Android.Runtime;
using Android.Views;
using Android.Widget;
using Android.Graphics.Drawables;</p>

<p>namespace MonoDroid.CustomList
{</p>

<pre><code>public class CustomListAdapter : BaseAdapter
{
    Activity context;

    public List&lt;Animal&gt; items;

    public CustomListAdapter(Activity context) //We need a context to inflate our row view from
        : base()
    {
        this.context = context;

        //For demo purposes we hard code some data here
        this.items = new List&lt;Animal&gt;() {
            new Animal() { Name = "Elephant", Description = "Big and Gray, but what the hey", Image = Resource.drawable.elephant },
            new Animal() { Name = "Chinchilla", Description = "Little people of the andes", Image = Resource.drawable.chinchilla },
            new Animal() { Name = "Lion", Description = "Cowardly lion, anyone?", Image = Resource.drawable.lion },
            new Animal() { Name = "Skunk", Description = "Ello, baby. I am ze locksmith of love, no?", Image = Resource.drawable.skunk },
            new Animal() { Name = "Rhino", Description = "Most live to about 60, pretty old eh?", Image = Resource.drawable.rhino },
            new Animal() { Name = "Zebra", Description = "Stripes maybe not so great for hiding", Image = Resource.drawable.zebra },
            new Animal() { Name = "Squirrel", Description = "Nuts nuts, where's my nuts?!", Image = Resource.drawable.squirrel },
            new Animal() { Name = "Walrus", Description = "I am he as you are he as you are me", Image = Resource.drawable.walrus },
            new Animal() { Name = "Giraffe", Description = "Bigger than your ford pinto", Image = Resource.drawable.giraffe },
            new Animal() { Name = "Chicken", Description = "I'll take 2 eggs over easy", Image = Resource.drawable.chicken },
            new Animal() { Name = "Duck", Description = "He's all quacked up", Image = Resource.drawable.duck },
            new Animal() { Name = "Hawk", Description = "He needs to be on a t-shirt", Image = Resource.drawable.hawk },
            new Animal() { Name = "Lobster", Description = "We were at the beach...", Image = Resource.drawable.lobster },
            new Animal() { Name = "Pig", Description = "Babe, Orson, Piglet, whatever", Image = Resource.drawable.pig },
            new Animal() { Name = "Rabbit", Description = "Thumper is the best rabbit name ever", Image = Resource.drawable.rabbit },
            new Animal() { Name = "Turtle", Description = "Slow and steady wins the race", Image = Resource.drawable.turtle },
        };
    }

    public override int Count
    {
        get { return items.Count; }
    }

    public override Java.Lang.Object GetItem(int position)
    {
        return position;
    }

    public override long GetItemId(int position)
    {
        return position;
    }

    public override View GetView(int position, View convertView, ViewGroup parent)
    {
        //Get our object for this position
        var item = items[position];         

        //Try to reuse convertView if it's not  null, otherwise inflate it from our item layout
        // This gives us some performance gains by not always inflating a new view
        // This will sound familiar to MonoTouch developers with UITableViewCell.DequeueReusableCell()
        var view = (convertView ?? 
            context.LayoutInflater.Inflate(
                Resource.layout.customlistitem, 
                parent, 
                false)) as LinearLayout;

        //Find references to each subview in the list item's view
        var imageItem = view.FindViewById(Resource.id.imageItem) as ImageView;
        var textTop = view.FindViewById(Resource.id.textTop) as TextView;
        var textBottom = view.FindViewById(Resource.id.textBottom) as TextView;

        //Assign this item's values to the various subviews
        imageItem.SetImageResource(item.Image);
        textTop.SetText(item.Name, TextView.BufferType.Normal);
        textBottom.SetText(item.Description, TextView.BufferType.Normal);

        //Finally return the view
        return view;
    }

    public Animal GetItemAtPosition(int position)
    {
        return items[position];
    }
}
</code></pre>

<p>}
~~~~</p>

<p>Oh, and here’s the Animal class if you’re curious:</p>

<p>~~~~{.csharp}
namespace MonoDroid.CustomList
{</p>

<pre><code>public class Animal
{
    public string Name
    {
        get;
        set;
    }

    public string Description
    {
        get;
        set;
    }

    public int Image
    {
        get;
        set;
    }
}
</code></pre>

<p>}
~~~~</p>

<p>Now for the sake of the demo, I create my own data inside the adapter, and of course nothing is stopping you from getting that data from a webservice, or somewhere more fashionable. The first thing to note is that I’m requiring an Activity object in the <em>ctor</em>. This really is only used to get the <em>LayoutInflator</em> for the given Activity so that we can inflate our row’s View later on, but it is important to have it. Next thing of interest is the overrides. All we really need to override is the <em>Count</em> property, <em>GetItem</em> method, <em>GetItemId</em> method, and <em>GetView</em> method. The last method (<em>GetItemAtPosition</em>) is my own addition so that I can read out the object for a given position elsewhere in the project (in this case, when a <em>ListView.ItemClicked</em> event is fired).</p>

<p><em>Count</em> is easy, just return your object list’s count (duh). <em>GetItem</em> and <em>GetItemId</em> I’m still not convinced are necessary, but I override them anyways and just return the position in each case. The only significance I know of so far with these properties is in some ListView events, the item Id is passed as an event arg. However, in these same events, we also get the item’s position, which is why I have the <em>GetItemAtPosition</em> method, so I can retrieve the relevant object for the event. I’d love to hear from anyone who knows more about why I might want to pay more attention to the GetItem and <em>GetItemId</em> methods.</p>

<p><em>GetView</em> is where the magic happens. Basically, I get the item for the given position first. Next, I determine if the <em>convertView</em> parameter is null or not, and inflate my CustomListItem’s layout into a usable View (<em>LinearLayout</em> to be specific). This is basically a way for us to reuse resources. Anyone familiar with MonoTouch and the Reusable <em>UITableViewCell</em> will feel right at home here. We could inflate the resource every time, but that would waste unnecessary resources. So, best practice here is to always reuse if the <em>convertView</em> is not null. Now then, with my <em>LinearLayout</em> instance, I can locate all of the views within that I want to assign information to, for the given row. As you can see in this case, I have an <em>ImageView</em>, and two <em>TextView</em>’s.</p>

<p>Here is what the layout xml looks like for my custom list item:</p>

<p>~~~~{.xml}
&lt;?xml version=&#8221;1.0&#8221; encoding=&#8221;utf-8&#8221;?>
&lt;LinearLayout xmlns:android=&#8221;http://schemas.android.com/apk/res/android&#8221;</p>

<pre><code>android:id="@+id/widget28"
android:layout_width="fill_parent"
android:layout_height="80px"
</code></pre>

<blockquote><pre><code>&lt;ImageView
android:id="@+id/imageItem"
android:layout_width="wrap_content"
android:layout_height="wrap_content"
android:layout_gravity="center_vertical"
    &gt;
&lt;/ImageView&gt;
&lt;LinearLayout
android:id="@+id/linearText"
android:layout_width="wrap_content"
android:layout_height="fill_parent"
android:orientation="vertical"
android:layout_marginLeft="10px"
android:layout_marginTop="10px"
    &gt;
    &lt;TextView
    android:id="@+id/textTop"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:text="TextView"
        &gt;
    &lt;/TextView&gt;
    &lt;TextView
    android:id="@+id/textBottom"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:text="TextView"
        &gt;
    &lt;/TextView&gt;
&lt;/LinearLayout&gt;
</code></pre>

<p></LinearLayout>
~~~~</p></blockquote>

<p>Once I have found references to these, I can set their text and image. Finally, I can return the <em>LinearLayout</em> View that I’ve been working on for this row. That wasn’t so hard, was it? Last, but not least, we need to actually deal with our <em>Activity</em> that holds the <em>ListView</em>. Up until now we had just created the adapter that our <em>ListView</em> was going to use. Now we need to actually hook an adapta’ up.</p>

<p>Here’s what my Activity code looks like:</p>

<p>~~~~{.csharp}
using System;
using Android.App;
using Android.Content;
using Android.Runtime;
using Android.Views;
using Android.Widget;
using Android.OS;</p>

<p>namespace MonoDroid.CustomList
{</p>

<pre><code>[Activity(Label = "1 CustomList", MainLauncher = true)]
public class CustomList : Activity
{
    CustomListAdapter listAdapter;

    public CustomList(IntPtr handle)
        : base(handle)
    {
    }

    protected override void OnCreate(Bundle bundle)
    {
        base.OnCreate(bundle);

        //Set the Activity's view to our list layout        
        SetContentView(Resource.layout.customlist);

        //Create our adapter
        listAdapter = new CustomListAdapter(this);

        //Find the listview reference
        var listView = FindViewById&lt;ListView&gt;(Resource.id.listView);

        //Hook up our adapter to our ListView
        listView.Adapter = listAdapter;

        //Wire up the click event
        listView.ItemClick += new EventHandler&lt;ItemEventArgs&gt;(listView_ItemClick);
    }

    void listView_ItemClick(object sender, ItemEventArgs e)
    {
        //Get our item from the list adapter
        var item = this.listAdapter.GetItemAtPosition(e.Position);

        //Make a toast with the item name just to show it was clicked
        Toast.MakeText(this, item.Name + " Clicked!", ToastLength.Short).Show();
    }
}
</code></pre>

<p>}
~~~~</p>

<p>Here’s the layout xml behind this activity:</p>

<p>~~~~{.xml}
&lt;?xml version=&#8221;1.0&#8221; encoding=&#8221;utf-8&#8221;?>
&lt;LinearLayout
android:id=&#8221;@+id/widget28&#8221;
android:layout_width=&#8221;fill_parent&#8221;
android:layout_height=&#8221;fill_parent&#8221;
android:orientation=&#8221;vertical&#8221;
xmlns:android=&#8221;http://schemas.android.com/apk/res/android&#8221;</p>

<blockquote><pre><code>&lt;ListView
android:id="@+id/listView"
android:layout_width="fill_parent"
android:layout_height="fill_parent"
</code></pre></blockquote>

<pre><code>&lt;/ListView&gt;
</code></pre>

<p></LinearLayout>
~~~~</p>

<p>So you can see in my Activity’s <em>OnCreate</em>, I’m calling the base method (important), and then setting the activity’s content view to the layout xml that I showed you above. I’m also creating an instance of the <em>CustomListAdapter</em> I made earlier, and finding a reference to my ListView, so that I can set my <em>ListView</em>’s .<em>Adapter</em> property to the instance of the <em>CustomListAdapter</em>. As a bonus, I register the <em>ItemClick</em> event of my <em>ListView</em>, and in it, retrieve the item for the given position, from my <em>CustomListAdapter</em>, using the method I added to the adapter (<em>GetItemPositionAt</em>). I then display a Toast with the name of the Animal clicked.</p>

<p>Hopefully this little tutorial enlightens you on how to make some fancy lists (not those boring default ones). I’ve also made the source code of the entire project available:</p>

<p>http://goo.gl/AcGI</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/Blog/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/Blog/month-with-android">A Month With Android</a>
      </li>
    
      <li class="post">
        <a href="/Blog/get-your-monotouch-apps-ready-for-iphone-5-today">Get your MonoTouch apps ready for iPhone 5 / iOS 6 today!</a>
      </li>
    
      <li class="post">
        <a href="/Blog/the-problem-with-apples-push-notification-ser">The problem with Apples Push Notification Service&#8230; Solutions and Workarounds&#8230;</a>
      </li>
    
      <li class="post">
        <a href="/Blog/2010/10/12/monodroid-custom-listadapter-for-your-listview">MonoDroid - Custom ListAdapter for your ListView</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Jon -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
